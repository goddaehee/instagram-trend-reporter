name: ðŸ“Š ì¸ìŠ¤íƒ€ê·¸ëž¨ ì£¼ê°„ íŠ¸ë Œë“œ ë¦¬í¬íŠ¸

on:
  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 8ì‹œ (KST) = ì¼ìš”ì¼ 23ì‹œ (UTC)
  schedule:
    - cron: '0 23 * * 0'
  
  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”
  workflow_dispatch:
    inputs:
      days:
        description: 'ë¶„ì„ ê¸°ê°„ (ì¼)'
        required: false
        default: '7'
      send_email:
        description: 'ì´ë©”ì¼ ì „ì†¡'
        type: boolean
        default: true

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ðŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install -r requirements.txt
      
      - name: âš™ï¸ ì„¤ì • íŒŒì¼ ìƒì„±
        run: |
          mkdir -p config
          cat > config/settings.yaml << EOF
          apify:
            token: "${{ secrets.APIFY_TOKEN }}"
          
          accounts:
            - username: dip_magazine
              category: Fashion
            - username: the_edit.co.kr
              category: Fashion
            - username: on_fleekkk
              category: Fashion
            - username: fashionandstyle.official
              category: Fashion
            - username: luxmag.kr
              category: Fashion
            - username: histofit
              category: Fashion
          
          analysis:
            days: ${{ github.event.inputs.days || '7' }}
            content_type: reels
            limit_per_account: 50
            outlier_threshold: 2.0
            top_hashtags: 50
            top_viral: 7
          
          email:
            recipients:
              - dedurox@gmail.com
              - kimdh@lfcorp.com
          
          google:
            config_path: /tmp/google.yaml
            gmail_token_key: gmail-token-json
            sheets_token_key: google-sheets-token-json
          EOF
      
      - name: ðŸ”‘ Google OAuth ì„¤ì •
        run: |
          cat > /tmp/google.yaml << EOF
          oauth_client:
            client_id: "${{ secrets.GOOGLE_CLIENT_ID }}"
            client_secret: "${{ secrets.GOOGLE_CLIENT_SECRET }}"
          EOF
      
      - name: ðŸ” í† í° ë³µì›
        run: |
          # keyring ëŒ€ì‹  í™˜ê²½ë³€ìˆ˜ë¡œ í† í° ì „ë‹¬
          echo "GMAIL_TOKEN=${{ secrets.GMAIL_TOKEN }}" >> $GITHUB_ENV
          echo "SHEETS_TOKEN=${{ secrets.SHEETS_TOKEN }}" >> $GITHUB_ENV
      
      - name: ðŸš€ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          if [ "${{ github.event.inputs.send_email }}" = "false" ]; then
            python main.py run --no-email
          else
            python main.py run
          fi
        env:
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
          SHEETS_TOKEN: ${{ secrets.SHEETS_TOKEN }}
      
      - name: ðŸ“‹ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸ“Š ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ë¶„ì„ ê¸°ê°„: ${{ github.event.inputs.days || '7' }}ì¼" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
